<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>è–ªæ°´å°å·ï¼šæ‰“æ“Šæ…£è€é—†</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            text-align: center;
            background: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 0;
            touch-action: manipulation;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            /* é è¨­æ¸¸æ¨™æ”¹ç‚ºéµéš */
            cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg'  width='40' height='40' viewport='0 0 100 100' style='fill:black;font-size:24px;'><text y='50%'>ğŸ”¨</text></svg>") 16 0, auto;
        }

        /* --- è¨­å®šé¢æ¿ --- */
        #setupPanel {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            width: 90%;
            max-width: 450px;
            z-index: 10;
            max-height: 90vh;
            overflow-y: auto;
        }

        h1 { margin-top: 0; color: #d63031; }
        
        .input-group { margin: 15px 0; text-align: left; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        
        /* ç‹€æ…‹é¸æ“‡ Radio */
        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }
        .radio-label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .radio-label input { margin-right: 5px; }

        input[type="number"], input[type="file"] {
            padding: 10px;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        button.start-btn {
            padding: 15px 0;
            font-size: 20px;
            background: #d63031;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            font-weight: bold;
        }
        button.start-btn:hover { background: #c0392b; }

        /* --- éŠæˆ²é¢æ¿ --- */
        #gamePanel {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            position: relative;
        }

        /* é ‚éƒ¨è³‡è¨Šåˆ— */
        .top-bar {
            background: #2d3436;
            padding: 10px 20px;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 5;
            font-size: 18px;
        }
        .money-counter { color: #00b894; font-weight: bold; font-size: 24px; }
        .timer-counter { color: #fab1a0; }

        /* éŠæˆ²å€åŸŸ (å·¦å³åˆ†å‰²) */
        .game-area {
            flex: 1;
            display: flex;
            width: 100%;
            position: relative;
            background-color: #dfe6e9;
        }

        .side {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            border-right: 1px dashed rgba(0,0,0,0.1);
            position: relative;
            /* é»æ“Šæ™‚æ¸¸æ¨™å‘ˆç¾æ‰“æ“Šç‹€ */
            cursor: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg'  width='40' height='40' viewport='0 0 100 100' style='fill:black;font-size:24px;'><text y='50%'>ğŸ’¥</text></svg>") 16 0, pointer;
            transition: background 0.1s;
        }
        .side:last-child { border-right: none; }
        
        .side:active { background-color: rgba(255,0,0,0.1); }

        /* --- è§’è‰²èˆ‡ç‰¹æ•ˆ --- */
        
        /* é¬¼è‡‰/åœ–ç‰‡å®¹å™¨ */
        .target-box {
            width: 150px;
            height: 150px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 80px;
            user-select: none;
            transition: all 0.1s; /* è®“è®Šå½¢å¹³æ»‘ä¸€é»é» */
        }

        .target-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
            pointer-events: none;
        }

        /* é¼»é’è‡‰è…«æ¿¾é¡æ•ˆæœ */
        .bruised {
            /* é€é JS å‹•æ…‹æ”¹è®Š filter æ•¸å€¼ */
            filter: contrast(1) sepia(0) hue-rotate(0deg) blur(0px);
        }

        /* å‡ºç¾å‹•ç•« */
        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            60% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-anim {
            animation: popIn 0.1s ease-out forwards;
        }

        /* æ‰‹æ©Ÿæ§åˆ¶å€ */
        .mobile-controls {
            display: none;
            height: 120px;
            background: white;
        }
        .control-btn {
            flex: 1;
            font-size: 32px;
            border: none;
            color: white;
            font-weight: bold;
        }
        .btn-l { background: #0984e3; }
        .btn-r { background: #d63031; }
        
        @media (hover: none) and (pointer: coarse) {
            .mobile-controls { display: flex; }
        }
        
        /* æç¤ºæ–‡å­— */
        .hint-text {
            position: absolute;
            bottom: 140px;
            width: 100%;
            text-align: center;
            color: #636e72;
            pointer-events: none;
            font-size: 14px;
        }
        @media (hover: none) and (pointer: coarse) {
            .hint-text { bottom: 10px; color: #b2bec3; z-index: 6; }
        }
    </style>
</head>
<body>

    <!-- åˆå§‹è¨­å®šç•«é¢ -->
    <div id="setupPanel">
        <h1>ğŸ”¨ è–ªæ°´å°å·</h1>
        <p style="font-size:14px; color:#666;">ç”¨éµéšç™¼æ´©ï¼Œé †ä¾¿è¨ˆç®—ä½ çš„ã€Œåƒ¹å€¼ã€</p>

        <div class="input-group">
            <label>ç¾åœ¨ç‹€æ…‹ï¼š</label>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="workStatus" value="working" checked> ä¸Šç­ä¸­ (å·è–ªæ°´)
                </label>
                <label class="radio-label">
                    <input type="radio" name="workStatus" value="off"> å·²ä¸‹ç­ (æµªè²»ç”Ÿå‘½)
                </label>
            </div>
        </div>

        <div class="input-group">
            <label>æœˆè–ª (NT$)</label>
            <input type="number" id="salaryInput" value="45000">
        </div>

        <div class="input-group">
            <label>æœ€å¿«åæ‡‰é€Ÿåº¦ (ç§’)</label>
            <input type="number" id="speedInput" value="0.4" step="0.1" min="0.1" max="2.0">
            <div style="font-size:12px; color:#888;">æ•¸å­—è¶Šå°è¶Šé›£ï¼Œå»ºè­° 0.3~0.5</div>
        </div>

        <div class="input-group">
            <label>ä¸Šå‚³è¨å­é¬¼çš„ç…§ç‰‡ (é¸å¡«)</label>
            <input type="file" id="imageInput" accept="image/*">
            <div style="font-size:12px; color:#888;">è‹¥ä¸ä¸Šå‚³ï¼Œç³»çµ±å°‡æ´¾ç™¼éš¨æ©Ÿé¬¼è‡‰</div>
        </div>

        <button class="start-btn" id="startBtn">é–‹å§‹ç™¼æ´©ï¼</button>
    </div>

    <!-- éŠæˆ²é€²è¡Œç•«é¢ -->
    <div id="gamePanel">
        <div class="top-bar">
            <div>æ™‚é–“: <span id="timeDisplay" class="timer-counter">0s</span></div>
            <div class="money-counter" id="moneyDisplay">NT$ 0</div>
        </div>

        <div class="game-area">
            <div class="side" id="areaLeft" onclick="handleInput('left')"></div>
            <div class="side" id="areaRight" onclick="handleInput('right')"></div>
            <div class="hint-text">é›»è…¦æŒ‰å·¦å³éµ / æ‰‹æ©ŸæŒ‰ä¸‹æ–¹æŒ‰éˆ•</div>
        </div>

        <div class="mobile-controls">
            <button class="control-btn btn-l" id="btnLeft">â‡¦ å·¦é‚Š</button>
            <button class="control-btn btn-r" id="btnRight">å³é‚Š â‡¨</button>
        </div>
    </div>

    <script>
        // --- è®Šæ•¸å®£å‘Š ---
        const setupPanel = document.getElementById('setupPanel');
        const gamePanel = document.getElementById('gamePanel');
        const startBtn = document.getElementById('startBtn');
        
        const moneyDisplay = document.getElementById('moneyDisplay');
        const timeDisplay = document.getElementById('timeDisplay');
        
        const areaLeft = document.getElementById('areaLeft');
        const areaRight = document.getElementById('areaRight');
        const btnLeft = document.getElementById('btnLeft');
        const btnRight = document.getElementById('btnRight');

        let gameState = {
            salary: 0,
            perSecond: 0,
            status: 'working', // working or off
            startTime: 0,
            elapsed: 0,
            earned: 0,
            isPlaying: false,
            customImage: null,
            hitCount: 0 // ç”¨ä¾†è¨ˆç®—é¼»é’è‡‰è…«ç¨‹åº¦
        };

        let gameLoop = {
            timer: null,      // ç”¨ä¾†è¨ˆç®—åæ‡‰æ™‚é–“çš„ timeout
            moneyTimer: null, // ç”¨ä¾†æ›´æ–°é‡‘éŒ¢é¡¯ç¤ºçš„ interval
            currentSide: null,// 'left' or 'right'
            speed: 1000,      // ç•¶å‰é€Ÿåº¦ ms
            minSpeed: 300,    // æœ€å¿«é€Ÿåº¦
            emojis: ['ğŸ‘¹', 'ğŸ‘º', 'ğŸ’©', 'ğŸ’€', 'ğŸ‘½', 'ğŸ¤¡', 'ğŸ§Ÿ', 'ğŸ§›'],
            lastEmojiIndex: -1
        };

        // --- äº‹ä»¶ç›£è½ ---

        startBtn.addEventListener('click', initGame);

        // æ‰‹æ©ŸæŒ‰éˆ• (é˜²æ­¢é›™æ“Šç¸®æ”¾ & è§¸ç™¼é»æ“Š)
        btnLeft.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput('left'); });
        btnRight.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput('right'); });

        // éµç›¤æ§åˆ¶
        document.addEventListener('keydown', (e) => {
            if (!gameState.isPlaying) return;
            if (e.key === 'ArrowLeft') handleInput('left');
            if (e.key === 'ArrowRight') handleInput('right');
        });

        // --- æ ¸å¿ƒé‚è¼¯ ---

        function initGame() {
            // 1. è®€å–æ•¸å€¼
            const salaryVal = parseFloat(document.getElementById('salaryInput').value);
            const speedVal = parseFloat(document.getElementById('speedInput').value);
            const statusVal = document.querySelector('input[name="workStatus"]:checked').value;
            const fileInput = document.getElementById('imageInput');

            if (!salaryVal || salaryVal <= 0) return alert('è«‹è¼¸å…¥æ­£ç¢ºæœˆè–ª');
            if (!speedVal || speedVal <= 0) return alert('è«‹è¼¸å…¥æ­£ç¢ºé€Ÿåº¦');

            // 2. è¨­å®šåœ–ç‰‡
            if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    gameState.customImage = e.target.result;
                    startGameLogic(salaryVal, speedVal, statusVal);
                }
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                gameState.customImage = null;
                startGameLogic(salaryVal, speedVal, statusVal);
            }
        }

        function startGameLogic(salary, speedSec, status) {
            // åˆå§‹åŒ–è®Šæ•¸
            gameState.salary = salary;
            // 30å¤© * 24å°æ™‚ = 720å°æ™‚ (å…¨æœˆç§’æ•¸è¨ˆç®—è¼ƒç¬¦åˆ"ç”Ÿå‘½æµé€"æ¦‚å¿µ)
            gameState.perSecond = salary / (30 * 24 * 3600);
            gameState.status = status;
            gameState.isPlaying = true;
            gameState.hitCount = 0;
            
            gameLoop.speed = 1000; // åˆå§‹é€Ÿåº¦ 1ç§’
            gameLoop.minSpeed = speedSec * 1000;
            
            // åˆ‡æ›ç•«é¢
            setupPanel.style.display = 'none';
            gamePanel.style.display = 'flex';
            
            // é–‹å§‹è¨ˆæ™‚
            gameState.startTime = Date.now();
            
            // é¡¯ç¤ºæ›´æ–°è¿´åœˆ
            gameLoop.moneyTimer = setInterval(updateStats, 50);

            // å•Ÿå‹•éŠæˆ²å›åˆ
            nextRound();
        }

        function updateStats() {
            const now = Date.now();
            gameState.elapsed = (now - gameState.startTime) / 1000;
            gameState.earned = gameState.elapsed * gameState.perSecond;
            
            timeDisplay.textContent = `${gameState.elapsed.toFixed(1)}s`;
            moneyDisplay.textContent = `NT$ ${gameState.earned.toFixed(2)}`;
        }

        function nextRound() {
            if (!gameState.isPlaying) return;

            // æ¸…é™¤ä¸Šä¸€è¼ªç•«é¢
            areaLeft.innerHTML = '';
            areaRight.innerHTML = '';

            // æ±ºå®šä½ç½®
            const isRight = Math.random() > 0.5;
            gameLoop.currentSide = isRight ? 'right' : 'left';
            const targetDiv = isRight ? areaRight : areaLeft;

            // ç”¢ç”Ÿå…§å®¹ (é¬¼è‡‰æˆ–åœ–ç‰‡)
            const content = createContent();
            targetDiv.appendChild(content);

            // è¨­å®šè¶…æ™‚åˆ¤æ–·ï¼šå¦‚æœåœ¨ speed æ™‚é–“å…§æ²’æŒ‰ -> Game Over
            // æ³¨æ„ï¼šé€™è£¡æˆ‘å€‘çµ¦äºˆçš„æ™‚é–“å°±æ˜¯ç•¶å‰çš„æ›´æ–°é€Ÿåº¦
            clearTimeout(gameLoop.timer);
            gameLoop.timer = setTimeout(() => {
                if (gameState.isPlaying) {
                    gameOver('timeout');
                }
            }, gameLoop.speed);
        }

        function createContent() {
            const box = document.createElement('div');
            box.className = 'target-box pop-anim';

            // è¨ˆç®—é¼»é’è‡‰è…«æ¿¾é¡ (è¶Šå¾Œé¢è¶Šæ…˜)
            // hue-rotate: åç§»é¡è‰²ç”¢ç”Ÿç˜€é’ç´«ç´…è‰²
            // contrast: å¢åŠ å°æ¯”
            // transform: æ¯æ¬¡éš¨æ©Ÿæ­ªä¸€é»é»
            const damageLevel = gameState.hitCount;
            const hue = Math.min(damageLevel * 10, 280); // æœ€å¤šè½‰åˆ°ç´«è‰²
            const contrast = 1 + (damageLevel * 0.05);
            const rotate = (Math.random() * 40 - 20) + (damageLevel % 2 === 0 ? 10 : -10); // éš¨æ©Ÿæ—‹è½‰
            
            let styleString = `transform: rotate(${rotate}deg) scale(${1 + damageLevel*0.01});`;
            
            // å¦‚æœæœ‰æ‰“æ“Šéï¼ŒåŠ æ¿¾é¡
            if (gameState.hitCount > 0) {
                styleString += ` filter: contrast(${contrast}) hue-rotate(${hue}deg) sepia(0.3) saturate(2);`;
            }

            if (gameState.customImage) {
                // è‡ªè¨‚åœ–ç‰‡
                const img = document.createElement('img');
                img.src = gameState.customImage;
                img.style = styleString;
                box.appendChild(img);
            } else {
                // éš¨æ©Ÿé¬¼è‡‰ (ä¿è­‰ä¸é‡è¤‡)
                let newIndex;
                do {
                    newIndex = Math.floor(Math.random() * gameLoop.emojis.length);
                } while (newIndex === gameLoop.lastEmojiIndex);
                gameLoop.lastEmojiIndex = newIndex;

                const span = document.createElement('span');
                span.textContent = gameLoop.emojis[newIndex];
                span.style = styleString; // é¬¼è‡‰ä¹Ÿé©ç”¨è¢«æ‰“è…«çš„æ•ˆæœ
                box.appendChild(span);
            }
            
            return box;
        }

        function handleInput(userSide) {
            if (!gameState.isPlaying) return;

            // 1. åˆ¤æ–·å°éŒ¯
            if (userSide === gameLoop.currentSide) {
                // --- ç­”å°äº† ---
                gameState.hitCount++;
                
                // è¦–è¦ºå›é¥‹ï¼šéœ‡å‹•/é–ƒçˆ
                const target = userSide === 'left' ? areaLeft : areaRight;
                createHitEffect(target);

                // åŠ é€Ÿ (æ¯æ¬¡æ¸›å°‘ 10% æ™‚é–“ï¼Œç›´åˆ°æ¥µé™)
                gameLoop.speed = Math.max(gameLoop.minSpeed, gameLoop.speed * 0.9);
                
                // é€²å…¥ä¸‹ä¸€è¼ª (ç¨å¾®å»¶é²æ¥µçŸ­æ™‚é–“é¿å…è¦–è¦ºé‡ç–Šå¤ªåš´é‡ï¼Œæˆ–è€…ç›´æ¥åŸ·è¡Œ)
                // é€™è£¡ç›´æ¥åŸ·è¡Œä»¥ä¿æŒæµæš¢æ„Ÿï¼Œä½†å› ç‚ºæœ‰ setTimeout æª¢æŸ¥ timeoutï¼Œéœ€å…ˆæ¸…é™¤
                clearTimeout(gameLoop.timer); 
                nextRound();

            } else {
                // --- ç­”éŒ¯äº† ---
                gameOver('wrong');
            }
        }

        function createHitEffect(element) {
            // ç°¡å–®çš„æ‰“æ“Šé–ƒå…‰
            const flash = document.createElement('div');
            flash.style.position = 'absolute';
            flash.style.top = '0'; flash.style.left = '0';
            flash.style.width = '100%'; flash.style.height = '100%';
            flash.style.background = 'rgba(255, 255, 255, 0.6)';
            flash.style.pointerEvents = 'none';
            element.appendChild(flash);
            setTimeout(() => flash.remove(), 50);
        }

        function gameOver(reason) {
            gameState.isPlaying = false;
            clearInterval(gameLoop.moneyTimer);
            clearTimeout(gameLoop.timer);

            // åœæ­¢å¾Œçš„æ•¸æ“š
            const finalSeconds = gameState.elapsed.toFixed(2);
            const finalMoney = gameState.earned.toFixed(2);
            
            let msg = "";
            let title = "";

            // æ ¹æ“šå¤±æ•—åŸå› å¾®èª¿é–‹é ­
            if (reason === 'timeout') {
                title = "å¤ªæ…¢äº†ï¼åæ‡‰ä¸åŠï¼ğŸ˜«";
            } else {
                title = "æ‰“éŒ¯é‚Šäº†ï¼æ‰‹æ®˜ï¼ğŸ˜µ";
            }

            // æ ¹æ“šä¸Šç­ç‹€æ…‹ç”¢ç”Ÿæ–‡æ¡ˆ
            if (gameState.status === 'working') {
                msg = `${title}\n\nä½ å·²æµªè²»ä½ çš„ç”Ÿå‘½ç´¯ç©ï¼š${finalSeconds} ç§’\n\nğŸ‰ æ­å–œä½ å·²å·å¾—ï¼šNT$ ${finalMoney} å…ƒ`;
            } else {
                msg = `${title}\n\nä½ å·²æµªè²»ä½ çš„ç”Ÿå‘½ç´¯ç©ï¼š${finalSeconds} ç§’\n\nğŸ’¸ ä½ å°‘è³ºäº†ç´¯ç©é‡‘é¡ï¼šNT$ ${finalMoney} å…ƒ`;
            }

            // è®Šç´…èƒŒæ™¯è­¦ç¤º
            document.body.style.backgroundColor = '#ffe6e6';

            setTimeout(() => {
                alert(msg);
                resetGame();
            }, 100);
        }

        function resetGame() {
            document.body.style.backgroundColor = '#f0f2f5';
            setupPanel.style.display = 'block';
            gamePanel.style.display = 'none';
            areaLeft.innerHTML = '';
            areaRight.innerHTML = '';
            timeDisplay.textContent = '0s';
            moneyDisplay.textContent = 'NT$ 0';
        }

    </script>
</body>
</html>